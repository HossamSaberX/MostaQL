{% extends "base.html" %}

{% block content %}
<article class="card">
    <header class="preferences-header">
        <h1>إدارة التفضيلات</h1>
        <div class="status-badge" id="statusBadge" style="display: none;" aria-live="polite">
            <span id="statusText">جاري التحميل...</span>
        </div>
    </header>
    
    <div id="statusMessage" class="alert success" role="alert" aria-live="polite"></div>
    <div id="errorMessage" class="alert error" role="alert" aria-live="assertive"></div>
    
    <form id="preferencesForm" novalidate>
        {{ notification_options(email_checked=False, telegram_checked=False) }}
        
        <button type="submit" class="primary-btn" id="saveBtn">
            حفظ التفضيلات
        </button>
    </form>
    
    <button type="button" class="danger-btn unsubscribe-btn" id="unsubscribeAllBtn">
        إلغاء الاشتراك من كل شيء
    </button>
    
    <div class="back-link">
        <a href="/" class="helper-text">← العودة للصفحة الرئيسية</a>
    </div>
</article>

<div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>تأكيد الإلغاء</h3>
        <p>هل أنت متأكد من إلغاء الاشتراك من كل شيء؟</p>
        <div class="modal-actions">
            <button type="button" class="modal-btn-cancel" id="modalCancel">إلغاء</button>
            <button type="button" class="modal-btn-confirm" id="modalConfirm">نعم، إلغاء الاشتراك</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE_URL = window.location.port === '5500' || window.location.port === '5501'
        ? 'http://localhost:8000/api'
        : `${window.location.origin}/api`;
    
    let token = '{{ token or "" }}';
    if (!token) {
        token = new URLSearchParams(window.location.search).get('token');
    }
    if (!token) {
        const pathMatch = window.location.pathname.match(/\/unsubscribe\/([^\/]+)/);
        if (pathMatch) {
            token = pathMatch[1];
        }
    }
    
    const statusMessage = document.getElementById('statusMessage');
    const errorMessage = document.getElementById('errorMessage');
    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    const form = document.getElementById('preferencesForm');
    const saveBtn = document.getElementById('saveBtn');
    const unsubscribeAllBtn = document.getElementById('unsubscribeAllBtn');
    
    if (!token) {
        showError('رابط غير صالح');
        form.style.display = 'none';
        unsubscribeAllBtn.style.display = 'none';
    } else {
        loadPreferences();
    }
    
    async function loadPreferences() {
        try {
            const response = await fetch(`${API_BASE_URL}/preferences/${token}`);
            if (!response.ok) {
                throw new Error('Failed to load preferences');
            }
            
            const data = await response.json();
            
            document.getElementById('receiveEmail').checked = data.receive_email;
            document.getElementById('receiveTelegram').checked = data.receive_telegram;
            if (data.min_hiring_rate !== null) {
                document.getElementById('minHiringRate').value = data.min_hiring_rate;
            }
            
            if (data.unsubscribed) {
                showError('أنت غير مشترك حالياً');
                unsubscribeAllBtn.style.display = 'none';
            }
        } catch (err) {
            showError('حدث خطأ أثناء تحميل التفضيلات');
            console.error(err);
        }
    }
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const receiveEmail = document.getElementById('receiveEmail').checked;
        const receiveTelegram = document.getElementById('receiveTelegram').checked;
        const minHiringRateInput = document.getElementById('minHiringRate').value;
        const minHiringRate = minHiringRateInput ? parseFloat(minHiringRateInput) : null;
        
        if (!receiveEmail && !receiveTelegram) {
            showError('يجب اختيار طريقة إشعار واحدة على الأقل');
            return;
        }
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'جاري الحفظ...';
        statusMessage.style.display = 'none';
        errorMessage.style.display = 'none';
        
        try {
            const response = await fetch(`${API_BASE_URL}/preferences`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token,
                    receive_email: receiveEmail,
                    receive_telegram: receiveTelegram,
                    min_hiring_rate: minHiringRate
                }),
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showSuccess(data.message || 'تم حفظ التفضيلات بنجاح');
            } else {
                showError(data.detail || 'حدث خطأ أثناء حفظ التفضيلات');
            }
        } catch (err) {
            console.error(err);
            showError('حدث خطأ في الاتصال');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'حفظ التفضيلات';
        }
    });
    
    const confirmModal = document.getElementById('confirmModal');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalCancel = document.getElementById('modalCancel');
    
    unsubscribeAllBtn.addEventListener('click', () => {
        confirmModal.style.display = 'flex';
    });
    
    modalCancel.addEventListener('click', () => {
        confirmModal.style.display = 'none';
    });
    
    modalConfirm.addEventListener('click', async () => {
        confirmModal.style.display = 'none';
        unsubscribeAllBtn.disabled = true;
        unsubscribeAllBtn.textContent = 'جاري الإلغاء...';
        
        try {
            const response = await fetch(`${API_BASE_URL}/unsubscribe/${token}`, {
                method: 'POST',
            });
            
            if (response.ok) {
                statusBadge.className = 'status-badge inactive';
                statusText.textContent = 'غير مشترك';
                statusBadge.classList.add('show');
                form.style.display = 'none';
                unsubscribeAllBtn.style.display = 'none';
                showSuccess('تم إلغاء الاشتراك بنجاح');
            } else {
                const data = await response.json();
                showError(data.detail || 'حدث خطأ أثناء إلغاء الاشتراك');
            }
        } catch (err) {
            console.error(err);
            showError('حدث خطأ في الاتصال');
        } finally {
            unsubscribeAllBtn.disabled = false;
            unsubscribeAllBtn.textContent = 'إلغاء الاشتراك من كل شيء';
        }
    });
    
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
            confirmModal.style.display = 'none';
        }
    });
    
    function showSuccess(message) {
        statusMessage.textContent = message;
        statusMessage.style.display = 'block';
        statusMessage.classList.add('show');
        errorMessage.style.display = 'none';
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        errorMessage.classList.add('show');
        statusMessage.style.display = 'none';
    }
    
    function hideMessages() {
        statusMessage.style.display = 'none';
        errorMessage.style.display = 'none';
    }
</script>
{% endblock %}

